{
  "id": "header-manipulation",
  "version": 1,
  "agentId": "api-gateway-agent",
  "protocol": "http",
  "defaults": {
    "timeoutMs": 6000
  },
  "nodes": [
    {
      "id": "auth",
      "type": "auth.jwt.validate",
      "config": {
        "issuer": "https://auth.example.com",
        "audience": "api"
      },
      "posture": "fail-closed",
      "on": {
        "success": "remove_sensitive_headers",
        "failure": "deny"
      }
    },
    {
      "id": "remove_sensitive_headers",
      "type": "transform.headers.remove",
      "config": {
        "headers": ["Authorization", "X-Internal-Token", "Cookie"]
      },
      "on": {
        "success": "add_proxy_headers"
      }
    },
    {
      "id": "add_proxy_headers",
      "type": "transform.headers.add",
      "config": {
        "headers": {
          "X-Forwarded-By": "polis",
          "X-Proxy-Version": "1.0.0",
          "X-Request-ID": "${request.id}",
          "X-Agent-ID": "${agent.id}"
        }
      },
      "on": {
        "success": "set_upstream_auth"
      }
    },
    {
      "id": "set_upstream_auth",
      "type": "egress.token.inject",
      "config": {
        "token_endpoint": "https://auth.example.com/token",
        "scope": "api.access",
        "client_id": "proxy-client"
      },
      "posture": "fail-closed",
      "on": {
        "success": "egress",
        "failure": "deny"
      }
    },
    {
      "id": "egress",
      "type": "egress.http",
      "config": {
        "upstream_url": "https://backend.example.com",
        "timeout_ms": 4000
      },
      "governance": {
        "timeoutMs": 4000,
        "circuitBreaker": {
          "window": "10s",
          "failureRateThreshold": 50
        }
      },
      "on": {
        "success": "remove_internal_response_headers",
        "failure": "deny",
        "timeout": "deny"
      }
    },
    {
      "id": "remove_internal_response_headers",
      "type": "transform.headers.remove",
      "config": {
        "headers": ["X-Internal-Server", "X-Debug-Info"],
        "scope": "response"
      },
      "on": {
        "success": "allow"
      }
    },
    {
      "id": "allow",
      "type": "terminal.allow"
    },
    {
      "id": "deny",
      "type": "terminal.deny"
    }
  ]
}
