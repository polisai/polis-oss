{
  "id": "multi-policy",
  "version": 1,
  "agentId": "multi-policy-agent",
  "protocol": "http",
  "defaults": {
    "timeoutMs": 8000,
    "retries": {
      "strategy": "exponential",
      "maxAttempts": 2,
      "baseMs": 100,
      "maxMs": 500
    }
  },
  "nodes": [
    {
      "id": "auth",
      "type": "auth.jwt.validate",
      "config": {
        "issuer": "https://auth.example.com",
        "audience": "api://primary"
      },
      "posture": "fail-closed",
      "on": {
        "success": "access_policy",
        "failure": "deny"
      }
    },
    {
      "id": "access_policy",
      "type": "policy.opa",
      "config": {
        "bundleRef": "access-policies",
        "bundleVersion": 1,
        "entrypoint": "policy/access/decision"
      },
      "posture": "fail-closed",
      "on": {
        "success": "waf_ingress",
        "failure": "deny"
      }
    },
    {
      "id": "waf_ingress",
      "type": "policy.waf",
      "config": {
        "rules": ["sql_injection", "xss", "path_traversal"],
        "action": "block"
      },
      "posture": "fail-closed",
      "governance": {
        "timeoutMs": 750
      },
      "on": {
        "success": "dlp_request",
        "failure": "deny"
      }
    },
    {
      "id": "dlp_request",
      "type": "policy.dlp",
      "config": {
        "rules": ["credit_card", "api_key"],
        "action": "redact",
        "scope": "request"
      },
      "posture": "fail-open",
      "governance": {
        "timeoutMs": 1000
      },
      "on": {
        "success": "cost_policy",
        "failure": "cost_policy"
      }
    },
    {
      "id": "cost_policy",
      "type": "policy.opa",
      "config": {
        "bundleRef": "cost-policies",
        "bundleVersion": 1,
        "entrypoint": "policy/cost/decision"
      },
      "posture": "fail-closed",
      "on": {
        "success": "egress",
        "failure": "deny"
      }
    },
    {
      "id": "egress",
      "type": "egress.http",
      "config": {
        "upstream_url": "http://127.0.0.1:8081/echo",
        "timeout_ms": 4000
      },
      "governance": {
        "timeoutMs": 4000
      },
      "on": {
        "success": "allow",
        "failure": "deny",
        "timeout": "deny"
      }
    },
    {
      "id": "allow",
      "type": "terminal.allow"
    },
    {
      "id": "deny",
      "type": "terminal.deny"
    }
  ]
}
