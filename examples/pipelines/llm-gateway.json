{
  "id": "llm-gateway",
  "version": 1,
  "agentId": "llm-agent",
  "protocol": "http",
  "defaults": {
    "timeoutMs": 30000,
    "retries": {
      "maxAttempts": 2,
      "backoff": "fixed",
      "baseMs": 1000
    }
  },
  "nodes": [
    {
      "id": "auth",
      "type": "auth.jwt.validate",
      "config": {
        "issuer": "https://auth.example.com",
        "audience": "llm-api"
      },
      "posture": "fail-closed",
      "on": {
        "success": "rate_limit_check",
        "failure": "deny"
      }
    },
    {
      "id": "rate_limit_check",
      "type": "policy.opa",
      "config": {
        "bundleRef": "rate-limits",
        "bundleVersion": 1,
        "entrypoint": "policy/rate_limit"
      },
      "posture": "fail-closed",
      "governance": {
        "timeoutMs": 500
      },
      "on": {
        "success": "content_policy",
        "failure": "rate_limited",
        "timeout": "deny"
      }
    },
    {
      "id": "content_policy",
      "type": "policy.opa",
      "config": {
        "bundleRef": "llm-policies",
        "bundleVersion": 1,
        "entrypoint": "policy/content_safety"
      },
      "posture": "fail-closed",
      "governance": {
        "timeoutMs": 1000
      },
      "on": {
        "success": "egress_token",
        "failure": "deny"
      }
    },
    {
      "id": "egress_token",
      "type": "egress.token.inject",
      "config": {
        "token_endpoint": "https://auth.example.com/token",
        "scope": "llm.api.access",
        "client_id": "proxy-client"
      },
      "posture": "fail-closed",
      "on": {
        "success": "egress",
        "failure": "deny"
      }
    },
    {
      "id": "egress",
      "type": "egress.http",
      "config": {
        "upstream_url": "https://api.openai.com/v1/chat/completions",
        "timeout_ms": 25000,
        "strip_headers": ["Authorization"]
      },
      "governance": {
        "timeoutMs": 25000,
        "circuitBreaker": {
          "window": "30s",
          "failureRateThreshold": 30,
          "slowCallDurationMs": 20000,
          "slowCallRateThreshold": 50
        }
      },
      "on": {
        "success": "response_policy",
        "failure": "deny",
        "timeout": "deny",
        "circuitOpen": "deny"
      }
    },
    {
      "id": "response_policy",
      "type": "policy.opa",
      "config": {
        "bundleRef": "llm-policies",
        "bundleVersion": 1,
        "entrypoint": "policy/response_safety"
      },
      "posture": "fail-open",
      "on": {
        "success": "allow",
        "failure": "allow"
      }
    },
    {
      "id": "allow",
      "type": "terminal.allow"
    },
    {
      "id": "deny",
      "type": "terminal.deny"
    },
    {
      "id": "rate_limited",
      "type": "terminal.deny",
      "config": {
        "status_code": 429,
        "message": "Rate limit exceeded"
      }
    }
  ]
}
