# TLS Termination Quick Start

Get HTTPS inspection working in under 2 minutes.

## Why TLS Termination?

**Problem**: When clients use HTTPS with HTTP CONNECT, Polis sees only encrypted bytes and cannot inspect traffic.

**Solution**: TLS termination - Polis decrypts incoming requests, applies governance (DLP, WAF, policies), and re-encrypts to upstream.

```
Client --HTTPS--> Polis (terminates TLS) --HTTPS--> Upstream
       encrypted  decrypt/inspect/govern   re-encrypt
```

## Quick Start

### 1. Generate Test Certificates (30 seconds)

```bash
# Build the certificate utility
go build -o build/polis-cert.exe ./cmd/polis-cert  # Windows
# go build -o build/polis-cert ./cmd/polis-cert     # Linux/macOS

# Generate complete test suite
./build/polis-cert generate -test-suite -output-dir build/certs
```

**Generated files:**
- `ca.crt`/`ca.key` - Certificate Authority
- `server.crt`/`server.key` - Server certificate (localhost, *.example.com)
- `client.crt`/`client.key` - Client certificate for mTLS
- `api.crt`/`api.key` - Domain-specific certificate

### 2. Configure TLS (30 seconds)

**Basic TLS:**
```yaml
server:
  tls:
    enabled: true
    cert_file: "./build/certs/server.crt"
    key_file: "./build/certs/server.key"
```

**With Client Authentication (mTLS):**
```yaml
server:
  tls:
    enabled: true
    cert_file: "./build/certs/server.crt"
    key_file: "./build/certs/server.key"
    client_auth:
      required: true
      ca_file: "./build/certs/ca.crt"
```

**With SNI (Multiple Domains):**
```yaml
server:
  tls:
    enabled: true
    cert_file: "./build/certs/server.crt"  # Default
    key_file: "./build/certs/server.key"
    sni:
      "api.example.com":
        cert_file: "./build/certs/api.crt"
        key_file: "./build/certs/api.key"
```

### 3. Run & Test (1 minute)

```bash
# Start Polis with TLS config
./build/polis --config examples/tls-termination/config.yaml

# Test HTTPS endpoint
curl -k https://localhost:8090/healthz
# → "ok"

# Send request through HTTPS proxy
curl -k -x https://localhost:8090 \
  https://api.openai.com/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -d '{"model":"gpt-4","messages":[{"role":"user","content":"Hello"}]}'
```

**The `-k` flag**: Skips certificate verification for self-signed certs. In production, use proper CA-signed certificates or distribute your CA cert to clients.

## What Just Happened?

1. ✅ **Client connects via HTTPS** to Polis
2. ✅ **Polis terminates TLS** using your certificate
3. ✅ **Request is now plaintext** - DLP, WAF, policies can inspect it
4. ✅ **Governance rules apply** - just like HTTP
5. ✅ **Polis re-encrypts** and forwards to upstream
6. ✅ **Response flows back** through the same pipeline

## Common Use Cases

### Development & Testing
Use self-signed certificates generated by `polis-cert`:
```bash
./build/polis-cert generate -cn localhost -cert dev.crt -key dev.key
```

### Production with Let's Encrypt
Use certbot or ACME client to get real certificates:
```yaml
server:
  tls:
    enabled: true
    cert_file: "/etc/letsencrypt/live/yourdomain.com/fullchain.pem"
    key_file: "/etc/letsencrypt/live/yourdomain.com/privkey.pem"
```

### Mutual TLS (mTLS) for Authentication
Require clients to present valid certificates:
```yaml
server:
  tls:
    enabled: true
    client_auth:
      required: true
      ca_file: "./build/certs/ca.crt"
      verify_mode: "require-and-verify"
```

Test with client certificate:
```bash
curl --cert ./build/certs/client.crt \
     --key ./build/certs/client.key \
     --cacert ./build/certs/ca.crt \
     https://localhost:8090/healthz
```

### SNI for Multiple Services
Route different domains to different certificates:
```yaml
server:
  tls:
    sni:
      "api.example.com":
        cert_file: "./certs/api.crt"
        key_file: "./certs/api.key"
      "admin.example.com":
        cert_file: "./certs/admin.crt"
        key_file: "./certs/admin.key"
```

## polis-cert Utility Reference

### Generate Certificates

```bash
# Basic self-signed certificate
./build/polis-cert generate -cn localhost -cert server.crt -key server.key

# With multiple DNS names (SAN)
./build/polis-cert generate \
  -cn "*.example.com" \
  -dns "*.example.com,example.com,api.example.com" \
  -cert wildcard.crt -key wildcard.key

# With IP addresses
./build/polis-cert generate \
  -cn "192.168.1.100" \
  -ips "192.168.1.100,10.0.0.1" \
  -cert server.crt -key server.key

# Long-term certificate (10 years)
./build/polis-cert generate \
  -cn localhost \
  -valid-for 87600h \
  -cert long-term.crt -key long-term.key

# Certificate Authority (for signing)
./build/polis-cert generate \
  -ca \
  -cn "My CA" \
  -org "My Organization" \
  -cert ca.crt -key ca.key

# Complete test suite
./build/polis-cert generate -test-suite -output-dir ./my-certs
```

### Inspect Certificates

```bash
# View certificate details
./build/polis-cert inspect -cert server.crt

# Example output:
# Subject: CN=localhost
# Issuer: CN=localhost
# Valid: 2024-12-15 to 2025-12-15
# DNS Names: localhost, example.com, *.example.com
# IP Addresses: 127.0.0.1, ::1
```

### Validate Certificate/Key Pairs

```bash
# Verify cert and key match
./build/polis-cert validate -cert server.crt -key server.key
```

## Configuration Examples

See [`configs/`](./configs/) directory for complete examples:

- **`basic-tls.yaml`** - Simple TLS termination
- **`mtls.yaml`** - Mutual TLS with client authentication
- **`sni-multi-domain.yaml`** - Multiple domains with SNI
- **`security-hardened.yaml`** - Production security settings
- **`multi-listener.yaml`** - HTTP on :8080, HTTPS on :8443

## Troubleshooting

### "certificate signed by unknown authority"
**Problem**: Client doesn't trust your self-signed certificate.

**Solutions**:
1. Use `-k` flag with curl for testing
2. Add your CA cert to client's trust store
3. Use proper CA-signed certificates in production

### "tls: failed to parse certificate from server"
**Problem**: Certificate file is invalid or corrupted.

**Solution**: Regenerate certificate with `polis-cert generate`

### "tls: bad certificate"
**Problem**: Client certificate validation failed (mTLS).

**Solution**: Ensure client cert is signed by the CA specified in `client_auth.ca_file`

### "connection refused"
**Problem**: Polis not listening on HTTPS port.

**Solution**: Check `server.tls.enabled: true` in config and verify port with `netstat` or `ss`

## Next Steps

- **[TLS Examples](./configs/)** - Complete configuration examples
- **[Security Guide](./SECURITY_PERFORMANCE_GUIDE.md)** - Production hardening
- **[Testing Guide](./TESTING_GUIDE.md)** - Comprehensive test scenarios
- **[Multi-Listener Guide](./MULTI_LISTENER_GUIDE.md)** - HTTP + HTTPS simultaneously

## Production Checklist

- [ ] Use proper CA-signed certificates (Let's Encrypt, DigiCert, etc.)
- [ ] Configure TLS 1.3 minimum version
- [ ] Use strong cipher suites only
- [ ] Enable mTLS for service-to-service communication
- [ ] Set up certificate rotation/renewal
- [ ] Configure proper trust bundles
- [ ] Enable certificate monitoring/alerting
- [ ] Test with production-like traffic patterns
