# Production-Ready TLS Configuration
# This example shows a production-ready TLS termination setup with security best practices

server:
  admin_address: ":19090"

  listen_params:
    # HTTPS listener with production security settings
    - address: ":8443"
      protocol: "https"
      tls:
        enabled: true
        cert_file: "/etc/polis/certs/server.crt"
        key_file: "/etc/polis/certs/server.key"

        # Security settings
        min_version: "1.2"  # Minimum TLS 1.2
        max_version: "1.3"  # Allow up to TLS 1.3

        # Strong cipher suites only
        cipher_suites:
          - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
          - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
          - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
          - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
          - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
          - "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305"

        # SNI configuration for multiple domains
        sni:
          "api.company.com":
            cert_file: "/etc/polis/certs/api-company-com.crt"
            key_file: "/etc/polis/certs/api-company-com.key"
          "secure.company.com":
            cert_file: "/etc/polis/certs/secure-company-com.crt"
            key_file: "/etc/polis/certs/secure-company-com.key"

    # Internal HTTP listener for health checks and monitoring
    - address: "127.0.0.1:8080"
      protocol: "http"

telemetry:
  otlp_endpoint: "https://telemetry.company.com:4317"
  insecure: false
  tls:
    cert_file: "/etc/polis/certs/telemetry-client.crt"
    key_file: "/etc/polis/certs/telemetry-client.key"
    ca_file: "/etc/polis/certs/telemetry-ca.crt"

control_plane:
  address: "control-plane.company.com:9090"
  mtls_enabled: true
  tls:
    cert_file: "/etc/polis/certs/control-plane-client.crt"
    key_file: "/etc/polis/certs/control-plane-client.key"
    ca_file: "/etc/polis/certs/control-plane-ca.crt"

pipelines:
  # Production API pipeline with comprehensive security
  - id: "production-api"
    version: 1
    description: "Production API with full security stack"
    agentId: "*"
    protocol: "http"
    match:
      headers:
        host: ["api.company.com"]
      listener_port: 8443
    nodes:
      # Rate limiting
      - id: "rate-limit"
        type: "governance.ratelimit"
        config:
          requests_per_minute: 10000
          burst_size: 100

      # Circuit breaker
      - id: "circuit-breaker"
        type: "governance.circuitbreaker"
        config:
          failure_threshold: 5
          timeout: "30s"

      # DLP scanning for sensitive data
      - id: "dlp-scan"
        type: "policy.dlp"
        config:
          rules: ["pii-detection", "financial-data", "api-keys", "tokens"]
          action: "block"  # Block requests with sensitive data

      # WAF protection
      - id: "waf-protection"
        type: "policy.waf"
        config:
          ruleset: "owasp-core"
          paranoia_level: 2
          action: "block"

      # LLM-based content analysis
      - id: "llm-judge"
        type: "llm.judge"
        config:
          provider: "openai"
          model: "gpt-4"
          rules: ["content-safety", "business-policy"]

      # Forward to secure backend
      - id: "api-egress"
        type: "egress.http"
        config:
          upstream_url: "https://api-backend.internal.company.com:8443"
          upstream_tls:
            enabled: true
            server_name: "api-backend.internal.company.com"
            ca_file: "/etc/polis/certs/internal-ca.crt"
            cert_file: "/etc/polis/certs/api-client.crt"
            key_file: "/etc/polis/certs/api-client.key"
            min_version: "1.2"

  # Secure admin interface
  - id: "secure-admin"
    version: 1
    description: "Secure admin interface with strict access controls"
    agentId: "*"
    protocol: "http"
    match:
      headers:
        host: ["secure.company.com"]
      listener_port: 8443
    nodes:
      # Strict rate limiting for admin
      - id: "admin-rate-limit"
        type: "governance.ratelimit"
        config:
          requests_per_minute: 100
          burst_size: 10

      # Admin access policy
      - id: "admin-policy"
        type: "policy.opa"
        config:
          policy: |
            package admin_access

            default allow = false

            # Require specific client certificate subject
            allow {
              input.tls.peer_certificates[0].subject.common_name == "admin.company.com"
              input.tls.peer_certificates[0].subject.organization == "Company Inc"
            }

            # Additional IP-based restrictions
            allow {
              net.cidr_contains("10.0.0.0/8", input.remote_addr)
              input.headers["x-admin-token"][_] != ""
            }

      # Audit logging
      - id: "audit-log"
        type: "telemetry.log"
        config:
          level: "info"
          message: "Admin access: ${request.method} ${request.path} from ${request.remote_addr}"
          fields:
            user_agent: "${request.headers.user_agent}"
            client_cert_cn: "${request.tls.peer_certificates[0].subject.common_name}"

      - id: "admin-egress"
        type: "egress.http"
        config:
          upstream_url: "https://admin-backend.internal.company.com:8443"
          upstream_tls:
            enabled: true
            ca_file: "/etc/polis/certs/internal-ca.crt"
            cert_file: "/etc/polis/certs/admin-client.crt"
            key_file: "/etc/polis/certs/admin-client.key"
            min_version: "1.3"  # Require TLS 1.3 for admin backend

  # Health check pipeline (HTTP only, internal)
  - id: "health-check"
    version: 1
    description: "Internal health check endpoint"
    agentId: "*"
    protocol: "http"
    match:
      listener_port: 8080
      path: ["/healthz", "/readiness", "/liveness"]
    nodes:
      - id: "health-response"
        type: "transform.response"
        config:
          status: 200
          headers:
            "content-type": "application/json"
          body: '{"status": "healthy", "timestamp": "${now}", "version": "${version}"}'

logging:
  level: "info"
  format: "json"
  fields:
    service: "polis-proxy"
    environment: "production"
    datacenter: "us-east-1"

# Security headers for web applications
security:
  headers:
    # HSTS (HTTP Strict Transport Security)
    strict_transport_security: "max-age=31536000; includeSubDomains; preload"

    # Content Security Policy
    content_security_policy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"

    # Other security headers
    x_frame_options: "DENY"
    x_content_type_options: "nosniff"
    x_xss_protection: "1; mode=block"
    referrer_policy: "strict-origin-when-cross-origin"
